# LogoCraft Web - Azure Implementation Notes

## Project Architecture
- **Frontend**: React app (Vite) hosted on Azure Static Web Apps
- **Backend**: Azure Functions (Node.js) integrated with Static Web App
- **Storage**: Azure Blob Storage with two containers:
  - `uploads`: Private, accessed via SAS tokens
  - `downloads`: Public blob access for processed results

## Essential Components

### Azure Resources
1. **Resource Group**: Container for all project resources
   - Create in required region: `New-AzResourceGroup -Name "YourProjectRG" -Location "centralus"`

2. **Storage Account**: 
   - Used for image storage (uploads & downloads)
   - Define public/private access per container
   - Configure CORS to allow browser uploads from SWA domain

3. **Static Web App**: 
   - Hosts frontend and backend (integrated functions)
   - Standard SKU for function support
   - Requires app settings for environment variables

4. **Application Insights**: 
   - For monitoring and troubleshooting

### Authentication Approaches
1. **Deployment Token** (Basic):
   - Simple GitHub Secrets approach
   - Static Web App generates token
   - Store in GitHub Secrets as `AZURE_STATIC_WEB_APPS_API_TOKEN`

2. **GitHub OIDC** (Advanced, recommended):
   - More secure, uses temporary credentials
   - Requires Entra ID application registration and federated credentials
   - Configure `id-token: write` permission in workflow

### Storage Considerations
1. **Container Setup**:
   - `uploads`: Private container
   - `downloads`: Public blob access

2. **CORS Configuration**:
   - Required for direct browser uploads
   - Must include Static Web App domain
   - Configure with: `Add-AzStorageCORSRule`

3. **SAS Token Authentication**:
   - Time-limited, scoped access
   - Generated by backend function

## Implementation Steps

### 1. Infrastructure Deployment
- Use Bicep templates for consistent, repeatable deployments
- Parameters to customize in templates:
  - Location
  - Resource naming
  - SKU sizes
- Define outputs for important resource info

### 2. CI/CD Workflow
- GitHub Actions workflow components:
  - Checkout code
  - Authentication (token or OIDC)
  - Build frontend
  - Deploy to Static Web App
  - Configure close action for pull requests

### 3. App Configuration
- Storage connection string must be added to Static Web App settings
- Function settings configured via Static Web App
- CORS configuration for Storage Account is critical

### 4. Post-Deployment
- Verify all containers exist and have correct access levels
- Test frontend-to-backend communication
- Check storage operations (upload & access)
- Monitor application with Application Insights

## Common Issues & Solutions

| Issue | Solution |
|-------|----------|
| CORS errors | Configure CORS in storage account for SWA domain |
| Missing app settings | Add storage connection string to SWA configuration |
| Build failures | Check output_location matches build tool (dist vs build) |
| Function errors | Verify Node.js version compatibility, check function logs |
| Auth failures | Validate secrets/credentials, check OIDC configuration |

## Best Practices
1. Use infrastructure as code (Bicep/ARM)
2. Configure GitHub OIDC for enhanced security
3. Set appropriate storage container access levels
4. Use Application Insights for monitoring
5. Configure automatic deployments via GitHub Actions
6. Organize code with clear frontend/backend separation
7. Store credentials in GitHub Secrets, not code
8. Test locally before deploying
9. Configure proper CORS settings for browser access

## Examples & Reference Configurations

### Bicep Template Key Points
```bicep
// Define parameters with descriptive names and defaults
param location string = 'centralus'
param namePrefix string = 'yourproject'

// Resources properly defined with dependencies
resource storageAccount '...storageAccounts@...' = { ... }
resource staticWebApp '...staticSites@...' = { ... }

// Set static web app app settings
resource swaAppSettings '...staticSites/config@...' = {
  parent: staticWebApp
  name: 'appsettings'
  properties: {
    AZURE_STORAGE_CONNECTION_STRING: storageAccount.listKeys().keys[0].value
  }
}
```

### GitHub Workflow Structure
```yaml
name: Deploy to Azure Static Web App

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]

jobs:
  build_and_deploy:
    # Job configuration...
    steps:
      - uses: actions/checkout@v3
      - name: Build And Deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          app_location: "frontend"
          api_location: "api"
          output_location: "dist"  # Match your build tool output
```